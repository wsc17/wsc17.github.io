<!DOCTYPE html>
<html lang="en-us">

<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="theme-color" content="#494f5c">
<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Mysql 简易分布式锁">
<meta itemprop="description" content="Mysql简易分布式锁的实现"><meta itemprop="datePublished" content="2023-11-16T14:39:30+08:00" />
<meta itemprop="dateModified" content="2024-05-24T16:11:31+08:00" />
<meta itemprop="wordCount" content="416">
<meta itemprop="keywords" content="mysql,lock," /><meta property="og:title" content="Mysql 简易分布式锁" />
<meta property="og:description" content="Mysql简易分布式锁的实现" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wsc17.github.io/posts/mysql/mysql-simple-lock/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-16T14:39:30+08:00" />
<meta property="article:modified_time" content="2024-05-24T16:11:31+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Mysql 简易分布式锁"/>
<meta name="twitter:description" content="Mysql简易分布式锁的实现"/>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
<link rel="shortcut icon" href="/favicon.ico"><title>Mysql 简易分布式锁</title>
<link rel="stylesheet" href="https://wsc17.github.io/css/style.min.2372f32ce2a23df002ef53bd50f891aa44160be19fe56daf9df576cf9b1acce1.css" integrity="sha256-I3LzLOKiPfAC71O9UPiRqkQWC+Gf5W2vnfV2z5sazOE=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://wsc17.github.io">Wushuchao | Blog</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://wsc17.github.io/posts/">文章</a>
				<a href="https://wsc17.github.io/about-hugo/">About</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="https://gitee.com/wuzuchao/wuzuchao" target="_blank" rel="noopener me" title="Gitee"><svg t="1700445689956" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11872" width="22" height="22"><path d="M978.467 409.614H455.101v0.011a45.51 45.51 0 0 0-45.51 45.499l-0.046 113.775a45.51 45.51 0 0 0 45.51 45.521l318.617-0.01a45.51 45.51 0 0 1 45.51 45.51v22.754c0 75.4-61.132 136.53-136.53 136.53h-432.38a45.51 45.51 0 0 1-45.51-45.51V341.35h-0.012c0-75.4 61.12-136.53 136.53-136.53h637.062v-0.024a45.51 45.51 0 0 0 45.51-45.487l0.102-113.775h0.023A45.51 45.51 0 0 0 978.467 0L341.326 0.023C152.823 0.023 0 152.846 0 341.349v637.14A45.51 45.51 0 0 0 45.51 1024h671.274c169.662 0 307.193-137.532 307.193-307.193V455.124a45.51 45.51 0 0 0-45.51-45.51z" fill="#ffffff" p-id="11873" data-spm-anchor-id="a313x.search_index.0.i57.70183a81pvKA1A" class="selected"></path></svg></a></span><button id="share-btn" class="hdr-btn" title="Share"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg></button>
 
<div id="share-links" class="animated fast">
    
    
    
    
    <ul>
        <li>
            <a href="https://twitter.com/intent/tweet?hashtags=hermit2&amp;url=https%3a%2f%2fwsc17.github.io%2fposts%2fmysql%2fmysql-simple-lock%2f&amp;text=Mysql%20%e7%ae%80%e6%98%93%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81" target="_blank" rel="noopener" aria-label="Share on X"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path class="st0" d="m21.3 21.1 -11.4 -18.2h-7.2l11.4 18.2zm-18.6 0 7.2 -6.6m4.2 -5 7.2 -6.6"/></svg></a>
        </li>
        <li>
            <a href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwsc17.github.io%2fposts%2fmysql%2fmysql-simple-lock%2f" target="_blank" rel="noopener" aria-label="Share on Facebook"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></a>
        </li>
        <li>
            <a href="mailto:?subject=Mysql%20%e7%ae%80%e6%98%93%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81&amp;body=https%3a%2f%2fwsc17.github.io%2fposts%2fmysql%2fmysql-simple-lock%2f" target="_self" rel="noopener" aria-label="Share on Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>
        </li>
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwsc17.github.io%2fposts%2fmysql%2fmysql-simple-lock%2f&amp;source=https%3a%2f%2fwsc17.github.io&amp;title=Mysql%20%e7%ae%80%e6%98%93%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81&amp;summary=Mysql%20%e7%ae%80%e6%98%93%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81%2c%20by%20wushuchao%0a%0aMysql%e7%ae%80%e6%98%93%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81%e7%9a%84%e5%ae%9e%e7%8e%b0%0a" target="_blank" rel="noopener" aria-label="Share on LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a>
        </li>
    </ul>
</div><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://wsc17.github.io/posts/">文章</a></li>
			<li><a href="https://wsc17.github.io/about-hugo/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster"><article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Nov 16, 2023</span></div>
				<h1>Mysql 简易分布式锁</h1>
			</header>
			<div class="post-info"><p>Mysql简易分布式锁的实现</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg><a href="/about-hugo/" target="_blank">wushuchao</a></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://wsc17.github.io/tags/mysql">mysql</a></span><span class="tag"><a href="https://wsc17.github.io/tags/lock">lock</a></span></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>416 Words
    … ⏲ Reading Time:
    
    
    
    1 Minute, 53 Seconds</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2023-11-16 14:39 &#43;0800&nbsp;[Modified : 2024-05-24 16:11 &#43;0800]</p></div>
			<hr class="post-end">
			<div class="content">
				<h2 id="一本文内容概述">一、本文内容概述<a href="#一本文内容概述" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>介绍锁。</p>
<p>锁的实现之：Mysql分布式锁。</p>
<h2 id="二为什么需要锁">二、为什么需要锁<a href="#二为什么需要锁" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>为什么需要用到锁，即：锁的作用是什么？可以用锁来解决什么问题？什么情况下需要用到锁？</p>
<h3 id="一锁的使用场景">（一）锁的使用场景<a href="#一锁的使用场景" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>列举几个实际开发中需要用到锁的场景。</p>
<h4 id="1避免某个业务重复执行">1.避免某个业务重复执行<a href="#1避免某个业务重复执行" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>例，系统A使用定时任务的方式，向系统B发送通知，并更新状态：</p>
<p><img src="/img/lock/LOCK_A_NOTICE_B.jpg" alt="示例图片"></p>
<p>如果定时任务执行频率较快，且系统A业务执行较慢，就会出现：对于同一条通知，第一次发送尚未完成（状态还没有更新为已发送），第二次发送又开始了，导致同一条通知重复发送2次到系统B。</p>
<p>为了避免这种情况，可以在系统A对这个业务进行加锁，实现：第一次发送尚未完成时，如果第二次发送也触发了，则第二次发送需要等待，等第一次发送完成后，第二次再继续执行：</p>
<p><img src="/img/lock/LOCK_A_NOTICE_B_LOCK.jpg" alt="示例图片"></p>
<h4 id="2避免商品超卖">2.避免商品超卖<a href="#2避免商品超卖" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>例，某商品库存只有10件，但有很多人同时来抢购商品，就可能会出现超卖（实际卖出的商品超过10件）。</p>
<p>此时通过加锁，保证：在一次购买结束后（库存扣减完成），再处理下一次购买：</p>
<p><img src="/img/lock/LOCK_BUY_LOCK.jpg" alt="示例图片"></p>
<h2 id="三什么是锁">三、什么是锁<a href="#三什么是锁" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>那么锁到底是什么？</p>
<h3 id="一锁是一种方法论">（一）锁是一种方法论<a href="#一锁是一种方法论" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>锁的本质，就是当资源发生竞争（同一个资源被多个对象竞争使用）时，把竞争变成排队执行，避免资源在同一时间内被多方同时使用。</p>
<p>锁，并不是一个具象的东西，它只是一种思想，一种解决问题的思路。</p>
<p>锁是一种方法论，需要开发者根据这个方法论的指导，去具体的实践，去实现锁。</p>
<h3 id="二名词解释">（二）名词解释<a href="#二名词解释" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<h4 id="1加锁">1.加锁<a href="#1加锁" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>（1）通过某种具体的方式（例，使用synchronized关键字修饰Java方法），使并发的线程排队执行，这个过程就称为加锁（获取锁）。</p>
<p>（2）线程排队执行时，每个线程都要先尝试加锁，如果加锁成功，则该线程可以继续执行。（3）反之，说明已经有其它线程获取了锁，则需要等待锁被释放。</p>
<p>（4）同时只会有一个线程加锁成功。</p>
<p>（5）多个线程时，哪个线程可以先加锁成功？</p>
<ul>
<li>
<p>有些锁的实现方式，无法设置线程加锁成功的先后（即，随机的）。</p>
</li>
<li>
<p>有些锁的实现方式，可以一定程度上实现公平锁（先来后到）。</p>
</li>
</ul>
<h4 id="2解锁">2.解锁<a href="#2解锁" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>（1）某个线程加锁成功，并且执行结束后，需要解锁（释放锁）。</p>
<p>（2）此时正在排队的线程就可以尝试加锁，并且会有一个线程加锁成功。</p>
<h4 id="3锁超时">3.锁超时<a href="#3锁超时" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>（1）有一些锁的实现方式，会给加锁的过程设置超时时间。超过这个时间后，就会释放锁。</p>
<p>（2）存在可能性：锁超时释放了锁，但线程并没有执行结束。此时，下一个线程获取到锁并且执行业务，则会导致上述的商品超卖问题。</p>
<p>（3）因此，需要开发者对超时时长设置一个合理值，但更重要的，应改优化业务代码，保证加锁过程中的业务代码不要执行太长时间。</p>
<h3 id="三对同一个资源加锁">（三）对同一个资源加锁<a href="#三对同一个资源加锁" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>（1）并不是对所有操作都需要加锁，当资源发生竞争时，才需要加锁。例，有两个线程同时调用同一个接口来购买商品。但是，第一个线程购买的是商品A，第二个线程购买的是商品B，则不需要加锁，二者可并行执行。</p>
<p>（2）此时，在代码层面加锁时，可以对一个业务数据唯一标识进行加锁。例，对商品id进行加锁。当多个线程购买同一个商品id时，才加锁排队执行。</p>
<h2 id="四mysql分布式锁">四、Mysql分布式锁<a href="#四mysql分布式锁" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>分布式的概念，这里不详细描述。</p>
<p>仅简单介绍系统的单体部署和多个部署。</p>
<h3 id="一单体多个部署">（一）单体/多个部署<a href="#一单体多个部署" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>当系统使用量比较一般时，通常只部署一个SpringBoot应用即可。</p>
<p>当系统客户较多，使用频繁时，可能需要部署多个SpringBoot应用，以保证系统性能及可用性。此时，大多配合Nginx来部署系统：</p>
<p><img src="/img/lock/LOCK_MULTI_SERVER.jpg" alt="示例图片"></p>
<p>如图，服务端多个部署的情况下，普通的锁（例，使用synchronized关键字修饰Java方法）都只是在各自的节点生效。</p>
<p>例，当2个客户端同时购买同一个商品，但是请求经过Nginx后，被转发到第1个和第2个服务端节点，则此时的锁就做不到让这两个请求排队执行（因为两个应用的代码是独立的）。</p>
<p>此时，就需要实现一个分布式锁。</p>
<h3 id="二mysql分布式锁">（二）Mysql分布式锁<a href="#二mysql分布式锁" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>分布式锁的实现方式有很多，这里仅介绍基于Mysql的分布式锁的简单实现。</p>
<h4 id="1唯一索引数据唯一性">1.唯一索引（数据唯一性）<a href="#1唯一索引数据唯一性" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>（1）Mysql分布式锁的实现，可基于表的主键或者唯一索引，这里介绍使用唯一索引的方式。</p>
<p>（2）在Mysql中使用唯一索引时，可以保证数据的唯一性。例，在表t_lock中，有字段lock_key，如果给这个字段设置了唯一索引，那么lock_key字段的值就不能重复（重复时无法保存）。</p>
<p>（3）唯一索引的这一特性，可用于实现Mysql分布式锁。</p>
<h4 id="2锁实现原理">2.锁实现原理<a href="#2锁实现原理" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>（1）新建t_lock表，有一列：lock_key，且给列设置唯一索引。</p>
<p>（2）加锁：往t_lock中插入一条数据，如果插入成功，则为加锁成功，反之则加锁失败。</p>
<p>（3）解锁：根据lock_key删除t_lock表的数据，删除成功即为解锁成功。</p>
<p>（4）例，同时有2个请求来更新【同一个用户】的账户余额：</p>
<ul>
<li>
<p>每个请求都要先获取锁（往t_lock表插入一条数据，用户id即为lock_key的值）。</p>
</li>
<li>
<p>最先在t_lock中插入数据的请求（假设为A），即为加锁成功，可【持锁】继续处理后续业务。</p>
</li>
<li>
<p>在A解锁之前，其它请求一直无法插入数据，也就是无法加锁成功，需等待解锁。</p>
</li>
<li>
<p>A执行结束并解锁后，其它请求又可以尝试加锁。</p>
</li>
<li>
<p>以此类推。</p>
</li>
</ul>
<h4 id="3锁的功能构成">3.锁的功能构成<a href="#3锁的功能构成" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>（1）实现锁时，至少需要实现锁最基本的功能：加锁，解锁。</p>
<p>（2）此外，可拓展实现的功能：多次尝试加锁，超时自动解锁。</p>
<p>（3）多次尝试加锁</p>
<ul>
<li>
<p>重试次数：在加锁失败后，再继续尝试加锁，在总共尝试K次加锁失败后，结束线程的执行。</p>
</li>
<li>
<p>重试间隔：每次重试需间隔一段时间。例，加锁失败后，等待5秒，再尝试下一次加锁。</p>
</li>
</ul>
<p>（4）超时自动解锁</p>
<ul>
<li>
<p>由于不可抗因素导致系统运行中断（例如停电），出现：已加锁成功，但是业务代码执行中断，后续解锁的代码也无法执行。此时就需要一个删除过期锁的功能，避免锁一直被持有，后续请求永远获取不到锁。</p>
</li>
<li>
<p>可结合定时任务来实现。</p>
</li>
<li>
<p>t_lock表中，建立一个expire_time字段，保存锁的过期时间。</p>
</li>
<li>
<p>定时任务扫描t_lock表，当前时间已经超过expire_time，则认为锁超时，将这条数据删除，以达到解锁的目的。</p>
</li>
</ul>
<h3 id="三java-示例">（三）Java 示例<a href="#三java-示例" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<h4 id="1表结构">1.表结构<a href="#1表结构" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>etl_business_lock<span style="color:#f92672">`</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> bigint(<span style="color:#ae81ff">20</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;id&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">`</span>lock_key<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">32</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;业务锁key&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">`</span>lock_value<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">32</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;业务锁value&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">`</span>create_time<span style="color:#f92672">`</span> datetime <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;创建时间&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">`</span>expire_time<span style="color:#f92672">`</span> datetime <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;过期时间&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">UNIQUE</span> <span style="color:#66d9ef">KEY</span> <span style="color:#f92672">`</span>lock_key_uidx<span style="color:#f92672">`</span> (<span style="color:#f92672">`</span>lock_key<span style="color:#f92672">`</span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;唯一索引&#39;</span>
</span></span><span style="display:flex;"><span>) ENGINE<span style="color:#f92672">=</span>InnoDB AUTO_INCREMENT<span style="color:#f92672">=</span><span style="color:#ae81ff">5009</span> <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8mb4 <span style="color:#66d9ef">COMMENT</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;业务锁信息表&#39;</span>
</span></span></code></pre></div><h4 id="2java示例">2.Java示例<a href="#2java示例" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 加锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Boolean <span style="color:#a6e22e">lock</span>(String lockKey, String lockValue, Integer expireSecond) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> tryLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 加锁（每3秒尝试一次加锁，最多尝试3次）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (i <span style="color:#f92672">&lt;=</span> TRY_LOCK_MAX_COUNT) {
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;business lock, try lock, current count: &#34;</span> <span style="color:#f92672">+</span> i);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Boolean insertLock <span style="color:#f92672">=</span> insertIgnore(lockKey, lockValue, expireSecond);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (insertLock) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;business lock, try lock success&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            tryLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#a6e22e">sleep</span>(TRY_LOCK_INTERVAL_MILLISECOND);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;business lock, try lock, Thread sleep error&#34;</span>, e);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tryLock;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 插入数据（忽略异常）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Boolean <span style="color:#a6e22e">insertIgnore</span>(String lockKey, String lockValue, Integer expireSecond) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1、当前时间</span>
</span></span><span style="display:flex;"><span>    Date now <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2、过期时间</span>
</span></span><span style="display:flex;"><span>    DateTime expireTime <span style="color:#f92672">=</span> DateUtil.<span style="color:#a6e22e">offsetSecond</span>(now, expireSecond);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3、创建数据</span>
</span></span><span style="display:flex;"><span>    BusinessLock businessLock <span style="color:#f92672">=</span> BusinessLockFactory.<span style="color:#a6e22e">create</span>(lockKey, lockValue, now, expireTime);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4、保存数据</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> affectRow <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">businessLockMapper</span>.<span style="color:#a6e22e">insert</span>(businessLock);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> affectRow <span style="color:#f92672">&gt;</span> 0;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;business lock, try lock, insert lock error&#34;</span>, e);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 解锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Boolean <span style="color:#a6e22e">unLock</span>(String lockKey) {
</span></span><span style="display:flex;"><span>    LambdaUpdateWrapper<span style="color:#f92672">&lt;</span>BusinessLock<span style="color:#f92672">&gt;</span> wrapper <span style="color:#f92672">=</span> Wrappers.<span style="color:#a6e22e">lambdaUpdate</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    wrapper.<span style="color:#a6e22e">eq</span>(BusinessLock::getLockKey, lockKey);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> delete <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">businessLockMapper</span>.<span style="color:#a6e22e">delete</span>(wrapper);
</span></span><span style="display:flex;"><span>    log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;business lock, unlock, delete result: &#34;</span> <span style="color:#f92672">+</span> delete);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> delete <span style="color:#f92672">&gt;</span> 0;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 删除过期锁（可以用定时任务触发）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">expire</span>() {
</span></span><span style="display:flex;"><span>    LambdaUpdateWrapper<span style="color:#f92672">&lt;</span>BusinessLock<span style="color:#f92672">&gt;</span> wrapper <span style="color:#f92672">=</span> Wrappers.<span style="color:#a6e22e">lambdaUpdate</span>();
</span></span><span style="display:flex;"><span>    wrapper.<span style="color:#a6e22e">lt</span>(BusinessLock::getExpireTime, <span style="color:#66d9ef">new</span> Date());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> affectRow <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">businessLockMapper</span>.<span style="color:#a6e22e">delete</span>(wrapper);
</span></span><span style="display:flex;"><span>    log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;business lock, expire check, delete lock num: &#34;</span> <span style="color:#f92672">+</span> affectRow);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="3锁api的使用">3.锁API的使用<a href="#3锁api的使用" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<ol>
<li>
<p>加锁（lock）：在执行业务代码之前，先调用加锁的方法。如果返回true，则加锁成功，继续往下执行业务代码；如果返回false，则加锁失败，在代码中return，不再执行业务代码。</p>
</li>
<li>
<p>解锁（unLock）：加锁成功的前提下，业务执行结束后，调用解锁的方法来释放锁。</p>
</li>
<li>
<p>删除超时锁（expire）：结合定时任务，调用删除过期锁的方法，将超时的锁进行解锁。</p>
</li>
</ol>
<h4 id="4拓展-循环和线程">4.拓展-循环和线程<a href="#4拓展-循环和线程" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>在while循环中使用Thread.sleep()时，不同的写法，会有差别：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1、第一种写法，IDEA会有警告提示：Call to &#39;Thread.sleep()&#39; in a loop, probably busy-waiting</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;</span> 10) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#a6e22e">sleep</span>(3 <span style="color:#f92672">*</span> 1000);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2、第二种写法，IDEA没有警告提示</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> k <span style="color:#f92672">=</span> 0;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (k <span style="color:#f92672">&lt;=</span> 10) {
</span></span><span style="display:flex;"><span>        k <span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#a6e22e">sleep</span>(3 <span style="color:#f92672">*</span> 1000);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
			</div>

		</article>
		<aside id="toc">
			<div class="toc-title">Table of Contents</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#一本文内容概述">一、本文内容概述</a></li>
    <li><a href="#二为什么需要锁">二、为什么需要锁</a>
      <ul>
        <li><a href="#一锁的使用场景">（一）锁的使用场景</a></li>
      </ul>
    </li>
    <li><a href="#三什么是锁">三、什么是锁</a>
      <ul>
        <li><a href="#一锁是一种方法论">（一）锁是一种方法论</a></li>
        <li><a href="#二名词解释">（二）名词解释</a></li>
        <li><a href="#三对同一个资源加锁">（三）对同一个资源加锁</a></li>
      </ul>
    </li>
    <li><a href="#四mysql分布式锁">四、Mysql分布式锁</a>
      <ul>
        <li><a href="#一单体多个部署">（一）单体/多个部署</a></li>
        <li><a href="#二mysql分布式锁">（二）Mysql分布式锁</a></li>
        <li><a href="#三java-示例">（三）Java 示例</a></li>
      </ul>
    </li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://wsc17.github.io/posts/txt/txt-read/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>TXT 文件读取</span>
			</a>
			<a class="prev-post" href="https://wsc17.github.io/posts/idea/idea-other/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>IDEA 其它设置</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

<footer id="site-footer" class="section-inner thin animated fadeIn faster">
	<p>
		&copy; 2024 <a href="https://wsc17.github.io">wushuchao</a>
		&#183; blog
		&#183; Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a>
		&#183; Theme <a href="https://github.com/1bl4z3r/hermit-V2" target="_blank" rel="noopener">Hermit-V2</a>
		
		&#183; <a href="https://wsc17.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		
	</p>

</footer>

	
<a href="#" class="scroll-up"><svg xmlns="http://www.w3.org/2000/svg" fill="#3B3E48" width="64px" height="64px" viewBox="-2.4 -2.4 28.80 28.80" id="up-circle" data-name="Flat Color" xmlns="http://www.w3.org/2000/svg" class="icon flat-color" stroke="#3B3E48" stroke-width="0.00024000000000000003"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="0.9600000000000002"><circle id="primary" cx="12" cy="12" r="10" style="fill: #3B3E48;"></circle><path id="secondary" d="M15,14a1,1,0,0,1-.71-.29L12,11.41l-2.29,2.3a1,1,0,0,1-1.42-1.42l3-3a1,1,0,0,1,1.42,0l3,3a1,1,0,0,1,0,1.42A1,1,0,0,1,15,14Z" style="fill: #018574;"></path></g><g id="SVGRepo_iconCarrier"><circle id="primary" cx="12" cy="12" r="10" style="fill: #3B3E48;"></circle><path id="secondary" d="M15,14a1,1,0,0,1-.71-.29L12,11.41l-2.29,2.3a1,1,0,0,1-1.42-1.42l3-3a1,1,0,0,1,1.42,0l3,3a1,1,0,0,1,0,1.42A1,1,0,0,1,15,14Z" style="fill: #018574;"></path></g></svg></a>
<noscript>
    <a href="#" class="scroll-up show"><svg xmlns="http://www.w3.org/2000/svg" fill="#3B3E48" width="64px" height="64px" viewBox="-2.4 -2.4 28.80 28.80" id="up-circle" data-name="Flat Color" xmlns="http://www.w3.org/2000/svg" class="icon flat-color" stroke="#3B3E48" stroke-width="0.00024000000000000003"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="0.9600000000000002"><circle id="primary" cx="12" cy="12" r="10" style="fill: #3B3E48;"></circle><path id="secondary" d="M15,14a1,1,0,0,1-.71-.29L12,11.41l-2.29,2.3a1,1,0,0,1-1.42-1.42l3-3a1,1,0,0,1,1.42,0l3,3a1,1,0,0,1,0,1.42A1,1,0,0,1,15,14Z" style="fill: #018574;"></path></g><g id="SVGRepo_iconCarrier"><circle id="primary" cx="12" cy="12" r="10" style="fill: #3B3E48;"></circle><path id="secondary" d="M15,14a1,1,0,0,1-.71-.29L12,11.41l-2.29,2.3a1,1,0,0,1-1.42-1.42l3-3a1,1,0,0,1,1.42,0l3,3a1,1,0,0,1,0,1.42A1,1,0,0,1,15,14Z" style="fill: #018574;"></path></g></svg></a>
</noscript>
<script async src="https://wsc17.github.io/js/scrollwatcher.min.11bd2ce6f91dfb64095448b76ac1930124a42dc7133488e6d3d5aae7badaf562.js" integrity="sha256-Eb0s5vkd+2QJVEi3asGTASSkLccTNIjm09Wq57ra9WI=" crossorigin="anonymous"></script>

	<script async src="https://wsc17.github.io/js/bundle.min.038214de9d568246fadcfeb06c69349925de3209f332ec123861b6aa031d63c6.js" integrity="sha256-A4IU3p1Wgkb63P6wbGk0mSXeMgnzMuwSOGG2qgMdY8Y=" crossorigin="anonymous"></script>
	
	
	
</body>

</html>
